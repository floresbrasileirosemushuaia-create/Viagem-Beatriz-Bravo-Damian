<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>CRM Cliente</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;

      --b1:#2563eb;
      --b2:#7c3aed;
      --g:#16a34a;
      --y:#f59e0b;
      --r:#ef4444;

      --shadow: 0 10px 22px rgba(15,23,42,.06);
      --radius: 18px;
      --radius2: 14px;

      --tap: 52px; /* bot√µes grandes p/ Chrome celular */
      --maxw: 520px; /* centraliza em desktop */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    /* Layout: "tela inteira", mas com max-width agrad√°vel em desktop */
    .app{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .frame{
      width:100%;
      max-width: var(--maxw);
      min-height:100vh;
      display:flex;
      flex-direction:column;
      padding: 14px 14px calc(14px + env(safe-area-inset-bottom) + 78px);
      gap: 12px;
    }

    /* Header */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 5;
      background: linear-gradient(180deg, rgba(246,247,251,.98), rgba(246,247,251,.88));
      backdrop-filter: blur(10px);
      padding-top: env(safe-area-inset-top);
    }
    .hdr{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 4px 8px;
    }
    .title{
      font-size: 22px;
      font-weight: 900;
      line-height:1.05;
      margin:0;
    }
    .subtitle{
      margin: 6px 0 0;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 999px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      min-height: 44px;
      white-space:nowrap;
      font-weight: 800;
      color: var(--muted);
      cursor:pointer;
    }
    .pill strong{color:var(--ink)}
    .pill:active{transform: scale(.99);}

    /* Tabs */
    .tabs{
      display:flex;
      gap: 10px;
      padding: 6px 4px 10px;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
    }
    .tab{
      flex: 0 0 auto;
      min-height: var(--tap);
      padding: 12px 16px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      box-shadow: var(--shadow);
      font-weight: 900;
      color: var(--ink);
      cursor:pointer;
    }
    .tab.active{
      border-color: rgba(37,99,235,.25);
      background: linear-gradient(90deg, rgba(37,99,235,.12), #fff);
      color: var(--b1);
    }

    /* Cards */
    .list{display:flex;flex-direction:column;gap: 12px;}
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      display:flex;
      gap: 10px;
      padding: 12px 12px;
      cursor:pointer;
    }
    .cardHead:active{transform: scale(.995);}
    .check{
      flex:0 0 auto;
      width: 22px;
      height: 22px;
      border-radius: 7px;
      border: 2px solid rgba(15,23,42,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      margin-top: 2px;
      background:#fff;
    }
    .check.on{
      background: rgba(37,99,235,.12);
      border-color: rgba(37,99,235,.55);
    }
    .check.on::after{
      content:"";
      width: 10px; height: 10px;
      border-radius: 3px;
      background: var(--b1);
    }

    .cardMain{flex:1 1 auto; min-width: 0;}
    .cardTitle{
      margin:0;
      font-size: 16px;
      font-weight: 1000;
      line-height:1.15;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 8px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      font-weight: 900;
      font-size: 12px;
      color: var(--muted);
      background:#fff;
      white-space:nowrap;
      max-width: 100%;
    }
    .chip strong{color:var(--ink)}
    .chip.ok{background: rgba(22,163,74,.10); border-color: rgba(22,163,74,.18); color: var(--g);}
    .chip.warn{background: rgba(245,158,11,.11); border-color: rgba(245,158,11,.18); color: var(--y);}
    .chip.purp{background: rgba(124,58,237,.10); border-color: rgba(124,58,237,.18); color: var(--b2);}
    .chip.blue{background: rgba(37,99,235,.10); border-color: rgba(37,99,235,.18); color: var(--b1);}

    .cardBody{
      padding: 0 12px 12px;
      border-top: 1px dashed rgba(229,231,235,.85);
      display:none; /* minimizado por padr√£o */
    }
    .card.open .cardBody{display:block;}
    .kv{
      display:flex;
      flex-direction:column;
      gap: 6px;
      margin-top: 10px;
    }
    .kvRow{
      display:grid;
      grid-template-columns: 110px 1fr;
      gap: 10px;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 10px;
      background: #fff;
    }
    .k{
      font-size: 12px;
      color: var(--muted);
      font-weight: 900;
    }
    .v{
      font-size: 13px;
      font-weight: 800;
      color: var(--ink);
      word-break: break-word;
      white-space: pre-wrap;
    }
    .v a{color: var(--b1); font-weight: 1000; text-decoration:none}

    .btnRow{
      display:flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .btn{
      flex: 1 1 140px;
      min-height: var(--tap);
      border-radius: 14px;
      border: 1px solid var(--line);
      background: #fff;
      box-shadow: var(--shadow);
      font-weight: 1000;
      cursor:pointer;
    }
    .btn.primary{
      border-color: rgba(37,99,235,.25);
      background: linear-gradient(90deg, rgba(37,99,235,.12), #fff);
      color: var(--b1);
    }

    /* Bottom actions */
    .bottomBar{
      position: fixed;
      left: 0; right: 0;
      bottom: 0;
      z-index: 10;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(246,247,251,.10), rgba(246,247,251,.98));
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(229,231,235,.9);
      display:flex;
      justify-content:center;
    }
    .bottomInner{
      width: 100%;
      max-width: var(--maxw);
      display:flex;
      gap: 10px;
    }
    .action{
      flex:1 1 0;
      min-height: 56px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background:#fff;
      box-shadow: var(--shadow);
      font-weight: 1100;
      cursor:pointer;
      position:relative;
      overflow:hidden;
    }
    .action.primary{
      border-color: rgba(124,58,237,.22);
      background: linear-gradient(90deg, rgba(124,58,237,.12), #fff);
      color: var(--b2);
    }
    .action:active{transform: scale(.99);}

    /* Login modal */
    .modalMask{
      position:fixed; inset:0;
      background: rgba(15,23,42,.35);
      display:none;
      z-index: 20;
      padding: 20px 14px;
      align-items:flex-end;
      justify-content:center;
    }
    .modalMask.on{display:flex;}
    .modal{
      width: 100%;
      max-width: var(--maxw);
      background:#fff;
      border-radius: 22px;
      box-shadow: 0 26px 80px rgba(15,23,42,.25);
      border: 1px solid rgba(229,231,235,.9);
      overflow:hidden;
    }
    .modalHd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(229,231,235,.9);
      background: linear-gradient(90deg, rgba(37,99,235,.10), #fff);
    }
    .modalHd h2{margin:0; font-size: 16px; font-weight: 1000;}
    .modalHd p{margin:6px 0 0; font-size: 12px; color: var(--muted); font-weight: 800;}
    .modalBd{padding: 14px; display:flex; flex-direction:column; gap: 10px;}
    .inp{
      width:100%;
      min-height: var(--tap);
      border-radius: 14px;
      border: 1px solid var(--line);
      padding: 12px 12px;
      font-size: 16px;
      font-weight: 900;
      outline:none;
      background:#fff;
    }
    .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .msg{
      display:none;
      border-radius: 14px;
      border: 1px solid rgba(239,68,68,.25);
      background: rgba(239,68,68,.08);
      color: var(--r);
      font-weight: 900;
      padding: 10px 12px;
      font-size: 13px;
    }
    .msg.on{display:block;}
    .modalFt{padding: 14px; display:flex; gap: 10px; border-top: 1px solid rgba(229,231,235,.9);}
    .modalFt .btn{min-height: 56px;}

    /* Overlay loading */
    .overlay{
      position:fixed; inset:0;
      display:none;
      z-index: 30;
      background: rgba(246,247,251,.82);
      backdrop-filter: blur(8px);
      align-items:center;
      justify-content:center;
      padding: 20px;
    }
    .overlay.on{display:flex;}
    .ovCard{
      width:100%;
      max-width: 420px;
      background:#fff;
      border:1px solid rgba(229,231,235,.9);
      border-radius: 20px;
      box-shadow: 0 26px 80px rgba(15,23,42,.18);
      padding: 14px;
    }
    .ovTitle{margin:0; font-weight:1000; font-size: 15px;}
    .ovSub{margin:6px 0 0; color:var(--muted); font-weight:800; font-size:12px;}
    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(229,231,235,.85);
      overflow:hidden;
      margin-top: 12px;
    }
    .bar > div{
      height:100%;
      width: 36%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(37,99,235,.25), rgba(124,58,237,.25));
      animation: load 1.0s infinite ease-in-out;
    }
    @keyframes load {
      0%{transform: translateX(-40%);}
      100%{transform: translateX(200%);}
    }

    /* Empty state */
    .empty{
      border:1px dashed rgba(148,163,184,.55);
      border-radius: 18px;
      padding: 14px;
      background: rgba(255,255,255,.7);
      color: var(--muted);
      font-weight: 900;
      text-align:center;
    }

    /* Desktop small tweak */
    @media (min-width: 700px){
      :root{--maxw: 640px;}
      .kvRow{grid-template-columns: 140px 1fr;}
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="frame">
      <div class="topbar">
        <div class="hdr">
          <div>
            <h1 id="appTitle" class="title">Carregando‚Ä¶</h1>
            <p id="appSub" class="subtitle">Dados carregados</p>
          </div>
          <button class="pill" id="btnAccount" type="button">
            <span>Conta</span>
            <strong>‚öôÔ∏è</strong>
          </button>
        </div>

        <div class="tabs" id="tabs">
          <button class="tab active" data-tab="passeios" type="button">passeios</button>
          <button class="tab" data-tab="pagamentos" type="button">pagamentos</button>
          <button class="tab" data-tab="voos" type="button">voos</button>
        </div>
      </div>

      <div id="errorBox" class="msg" style="display:block; border-color: rgba(239,68,68,.18); background: rgba(239,68,68,.06); color: #b91c1c; display:none;"></div>

      <div class="list" id="list"></div>

      <div class="empty" id="empty" style="display:none;">
        Sem registros nesta aba.
      </div>
    </div>
  </div>

  <!-- Bottom actions -->
  <div class="bottomBar">
    <div class="bottomInner">
      <button class="action" id="btnPdfSel" type="button">PDF selecionados</button>
      <button class="action" id="btnPdfTab" type="button">PDF aba</button>
      <button class="action primary" id="btnPdfFull" type="button">PDF completo</button>
    </div>
  </div>

  <!-- Modal Login / Conta -->
  <div class="modalMask" id="modalMask">
    <div class="modal">
      <div class="modalHd">
        <h2 id="modalTitle">Login</h2>
        <p id="modalHint">Entre com usu√°rio e senha</p>
      </div>
      <div class="modalBd">
        <div id="modalMsg" class="msg"></div>

        <input class="inp" id="inpUser" placeholder="Usu√°rio" autocomplete="username" />
        <input class="inp" id="inpPass" placeholder="Senha" type="password" autocomplete="current-password" />

        <div class="row2">
          <button class="btn primary" id="btnDoLogin" type="button">Entrar</button>
          <button class="btn" id="btnCancel" type="button">Fechar</button>
        </div>

        <div style="height:1px;background:rgba(229,231,235,.9);margin:6px 0;"></div>

        <div style="display:flex;flex-direction:column;gap:10px;">
          <div style="font-weight:1000;">Alterar login/senha</div>
          <input class="inp" id="inpNewUser" placeholder="Novo usu√°rio" autocomplete="off" />
          <input class="inp" id="inpNewPass" placeholder="Nova senha" type="password" autocomplete="off" />
          <button class="btn primary" id="btnSaveCreds" type="button">Salvar</button>
          <button class="btn" id="btnLogout" type="button">Sair</button>
        </div>

        <div style="font-size:12px;color:var(--muted);font-weight:800;">
          O SID n√£o √© mostrado. Ele fica salvo no cache do navegador ap√≥s abrir 1 vez com o link completo.
        </div>
      </div>
      <div class="modalFt">
        <button class="btn" id="btnClearSid" type="button">Trocar planilha</button>
        <button class="btn primary" id="btnReload" type="button">Recarregar</button>
      </div>
    </div>
  </div>

  <!-- Overlay -->
  <div class="overlay" id="overlay">
    <div class="ovCard">
      <p class="ovTitle" id="ovTitle">Carregando‚Ä¶</p>
      <p class="ovSub" id="ovSub">Aguarde.</p>
      <div class="bar"><div></div></div>
    </div>
  </div>

<script>
/** =================== CONFIG =================== **/
const API_BASE = "https://script.google.com/macros/s/AKfycbyzR-GumTo4rkGojAkXT8WWxEmwtUCuPHI3R34PiL2CULgJg2a0xT_uaYZ3xWvwNzpI/exec";

// cache keys
const LS_SID   = "crm_last_sid";
const LS_TOKEN = "crm_session_token";
const LS_USER  = "crm_last_user";

// estado
let SID = "";
let TOKEN = "";
let DATA = null;
let currentTab = "passeios";
let selected = new Map(); // key: tab|idx0 => true

/** =================== INIT =================== **/
boot();

async function boot(){
  try{
    hideError();

    // 1) sid da URL (1a vez) ou cache
    const urlSid = (new URLSearchParams(location.search).get("sid") || "").trim();
    if (urlSid) {
      localStorage.setItem(LS_SID, urlSid);
      // opcional: remove sid da barra do navegador (ocultar)
      try {
        const u = new URL(location.href);
        u.searchParams.delete("sid");
        history.replaceState({}, "", u.toString());
      } catch(_){}
    }

    SID = (localStorage.getItem(LS_SID) || "").trim();
    TOKEN = (localStorage.getItem(LS_TOKEN) || "").trim();

    if (!SID) {
      showError('Faltou a planilha. Abra 1 vez com um link que contenha "?sid=ID_DA_PLANILHA".');
      setTitle("CRM Cliente", "Sem planilha");
      return;
    }

    setOverlay(true, "Verificando acesso‚Ä¶", "Aguarde.");

    // 2) checa sess√£o / se exige login
    const sess = await api("checkSession", { sid: SID, token: TOKEN });
    if (!sess.ok && sess.authRequired) {
      setOverlay(false);
      // for√ßa login
      openModal("Login", "Entre com usu√°rio e senha para acessar.");
      return;
    }
    if (sess.ok) {
      setTitle(sess.clientName || "CRM Cliente", "Dados carregados");
    }

    // 3) carrega dados
    await loadData();

    setOverlay(false);

    // tabs
    initTabs();
    render();

    // bot√µes pdf
    initPdfButtons();

    // conta
    initAccount();

  }catch(err){
    setOverlay(false);
    showError("Falha ao carregar: " + (err?.message || String(err)));
  }
}

async function loadData(){
  setOverlay(true, "Carregando dados‚Ä¶", "Lendo planilha.");
  const res = await api("getSpreadsheetData", { sid: SID, token: TOKEN });
  if (!res.ok) {
    if (res.authRequired) {
      setOverlay(false);
      openModal("Login", "Sess√£o expirada. Fa√ßa login novamente.");
      return;
    }
    throw new Error(res.error || "Erro ao ler planilha.");
  }
  DATA = res;
  setTitle(res.clientName || res.title || "CRM Cliente", "Dados carregados");
  setOverlay(false);
}

/** =================== API =================== **/
async function api(fn, payload){
  const url = API_BASE + "?fn=" + encodeURIComponent(fn);
  const r = await fetch(url, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify(payload || {})
  });
  const txt = await r.text();
  let j;
  try { j = JSON.parse(txt); } catch(_) {
    // quando retorna HTML por erro de deploy ou rota errada
    throw new Error("Resposta n√£o √© JSON. Verifique deploy/URL do Apps Script.");
  }
  return j;
}

/** =================== UI helpers =================== **/
function setOverlay(on, t, s){
  const el = document.getElementById("overlay");
  document.getElementById("ovTitle").textContent = t || "Carregando‚Ä¶";
  document.getElementById("ovSub").textContent = s || "Aguarde.";
  el.classList.toggle("on", !!on);
}

function setTitle(title, sub){
  document.getElementById("appTitle").textContent = title || "CRM Cliente";
  document.getElementById("appSub").textContent = sub || "";
}

function showError(msg){
  const el = document.getElementById("errorBox");
  el.style.display = "block";
  el.textContent = msg;
}
function hideError(){
  const el = document.getElementById("errorBox");
  el.style.display = "none";
  el.textContent = "";
}

function openModal(title, hint){
  document.getElementById("modalTitle").textContent = title || "Login";
  document.getElementById("modalHint").textContent = hint || "";
  document.getElementById("modalMsg").classList.remove("on");
  document.getElementById("modalMsg").textContent = "";

  // preenche user salvo
  document.getElementById("inpUser").value = localStorage.getItem(LS_USER) || "";
  document.getElementById("inpPass").value = "";

  document.getElementById("inpNewUser").value = "";
  document.getElementById("inpNewPass").value = "";

  document.getElementById("modalMask").classList.add("on");

  setTimeout(()=> document.getElementById("inpUser").focus(), 50);
}
function closeModal(){
  document.getElementById("modalMask").classList.remove("on");
}

function modalError(msg){
  const el = document.getElementById("modalMsg");
  el.textContent = msg;
  el.classList.add("on");
}

/** =================== Tabs + Render =================== **/
function initTabs(){
  const wrap = document.getElementById("tabs");
  wrap.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      wrap.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      currentTab = btn.dataset.tab;
      render();
    });
  });
}

function getSheetNameForTab(tab){
  if (!DATA || !DATA.sheets) return "";
  const names = Object.keys(DATA.sheets);
  const lc = names.map(n => n.toLowerCase());

  const want = tab.toLowerCase();
  // prioridade exata
  let idx = lc.indexOf(want);
  if (idx >= 0) return names[idx];

  // fallback contains
  idx = lc.findIndex(n => n.includes(want));
  if (idx >= 0) return names[idx];

  // fallback: tenta nomes comuns
  if (want === "passeios") {
    idx = lc.findIndex(n => n.includes("passeio") || n.includes("atividade") || n.includes("actividad"));
    if (idx >= 0) return names[idx];
  }
  if (want === "pagamentos") {
    idx = lc.findIndex(n => n.includes("pagamento") || n.includes("payment"));
    if (idx >= 0) return names[idx];
  }
  if (want === "voos") {
    idx = lc.findIndex(n => n.includes("voo") || n.includes("flight") || n.includes("vuelo"));
    if (idx >= 0) return names[idx];
  }

  return names[0] || "";
}

function render(){
  const list = document.getElementById("list");
  const empty = document.getElementById("empty");
  list.innerHTML = "";

  if (!DATA || !DATA.sheets) {
    empty.style.display = "block";
    return;
  }

  const sheetName = getSheetNameForTab(currentTab);
  const sh = DATA.sheets[sheetName];
  const rows = sh?.rows || [];
  const links = sh?.links || [];

  if (!rows.length) {
    empty.style.display = "block";
    empty.textContent = "Sem registros nesta aba.";
    return;
  }
  empty.style.display = "none";

  rows.forEach((row, idx0) => {
    const linkMap = links[idx0] || {};
    const keySel = currentTab + "|" + idx0;
    const isSelected = !!selected.get(keySel);

    const card = document.createElement("div");
    card.className = "card";

    const head = document.createElement("div");
    head.className = "cardHead";

    const chk = document.createElement("div");
    chk.className = "check" + (isSelected ? " on" : "");
    chk.addEventListener("click", (ev)=>{
      ev.stopPropagation();
      toggleSelect(currentTab, idx0);
      render(); // simples e consistente
    });

    const main = document.createElement("div");
    main.className = "cardMain";

    const title = document.createElement("p");
    title.className = "cardTitle";
    title.textContent = cardTitleForTab(currentTab, row, idx0);

    const meta = document.createElement("div");
    meta.className = "meta";
    buildChipsForTab(currentTab, row).forEach(ch => meta.appendChild(ch));

    main.appendChild(title);
    main.appendChild(meta);

    head.appendChild(chk);
    head.appendChild(main);

    head.addEventListener("click", ()=>{
      card.classList.toggle("open");
    });

    const body = document.createElement("div");
    body.className = "cardBody";

    // KV: inclui OBS sempre que existir
    const kv = document.createElement("div");
    kv.className = "kv";

    const kvRows = buildKvForTab(currentTab, row, linkMap);
    kvRows.forEach(el => kv.appendChild(el));

    const btnRow = document.createElement("div");
    btnRow.className = "btnRow";

    const bestLink = findBestLink(row, linkMap);
    if (bestLink) {
      const bOpen = document.createElement("button");
      bOpen.className = "btn primary";
      bOpen.type = "button";
      bOpen.textContent = "Abrir link / anexo";
      bOpen.addEventListener("click", (ev)=>{
        ev.stopPropagation();
        window.open(bestLink, "_blank", "noopener");
      });
      btnRow.appendChild(bOpen);
    }

    // bot√£o marcar sele√ß√£o tamb√©m dentro do card (mais f√°cil no celular)
    const bSel = document.createElement("button");
    bSel.className = "btn";
    bSel.type = "button";
    bSel.textContent = isSelected ? "Remover sele√ß√£o" : "Selecionar";
    bSel.addEventListener("click",(ev)=>{
      ev.stopPropagation();
      toggleSelect(currentTab, idx0);
      render();
    });
    btnRow.appendChild(bSel);

    body.appendChild(kv);
    body.appendChild(btnRow);

    card.appendChild(head);
    card.appendChild(body);

    list.appendChild(card);
  });
}

function toggleSelect(tab, idx0){
  const key = tab + "|" + idx0;
  if (selected.get(key)) selected.delete(key);
  else selected.set(key, true);
}

function chip(text, cls){
  const el = document.createElement("span");
  el.className = "chip " + (cls || "");
  el.textContent = text;
  return el;
}

function buildChipsForTab(tab, row){
  const out = [];
  const p = pickRow;

  if (tab === "passeios") {
    const data = p(row, ["Data","data","Fecha","fecha"]);
    const pickup = p(row, ["pick up","Pick up","Pickup","pickup","Pick-up","pick-up"]);
    const status = p(row, ["status","Status"]);
    const pag = p(row, ["pagamento","Pagamento"]);
    const valor = p(row, ["valor","Valor","preco","Pre√ßo","precio","Precio","total","Total"]);
    const turno = p(row, ["turno","Turno"]);

    if (data) out.push(chip("üìÖ " + data, "warn"));
    if (pickup) out.push(chip("üïí Pick up: " + pickup, "blue"));
    if (turno) out.push(chip("‚è±Ô∏è " + turno, "blue"));
    if (status) out.push(chip(status, "ok"));
    if (pag) out.push(chip(pag, (String(pag).toLowerCase().includes("pend") ? "warn" : "ok")));
    if (valor) out.push(chip(valor, "purp"));
    return out;
  }

  if (tab === "pagamentos") {
    const data = p(row, ["data do pagamento","Data do pagamento","Data","data","Fecha","fecha"]);
    const valor = p(row, ["valor","Valor","monto","Monto","importe","Importe","amount","Amount"]);
    const saldo = p(row, ["saldo atual","Saldo atual","saldo","Saldo"]);
    if (data) out.push(chip("üìÖ " + data, "warn"));
    if (valor) out.push(chip(valor, "purp"));
    if (saldo) out.push(chip("Saldo: " + saldo, "blue"));
    return out;
  }

  if (tab === "voos") {
    const data = p(row, ["Data","data","Fecha","fecha"]);
    const voo = p(row, ["numero do voo","N√∫mero do voo","n√∫mero do voo","vuelo","flight","voo","Voo"]);
    const origem = p(row, ["origem","Origem","origen","from"]);
    const destino = p(row, ["destino","Destino","to"]);
    const saida = p(row, ["hora de saida","hora de sa√≠da","Hora de saida","Hora de sa√≠da","salida","departure"]);
    const chegada = p(row, ["hora de chegada","Hora de chegada","llegada","arrival"]);
    if (data) out.push(chip("üìÖ " + data, "warn"));
    if (voo) out.push(chip("‚úàÔ∏è " + voo, "purp"));
    if (origem || destino) out.push(chip((origem||"") + " ‚Üí " + (destino||""), "blue"));
    if (saida) out.push(chip("Sa√≠da: " + saida, "blue"));
    if (chegada) out.push(chip("Chegada: " + chegada, "blue"));
    return out;
  }

  // fallback gen√©rico
  const obs = p(row, ["obs","OBS","observacoes","observa√ß√µes","observaciones"]);
  if (obs) out.push(chip("OBS", "blue"));
  return out;
}

function cardTitleForTab(tab, row, idx0){
  const p = pickRow;
  if (tab === "passeios") return p(row, ["passeio","Passeio","actividad","Atividad","atividade","Atividade"]) || ("Passeio #" + (idx0+1));
  if (tab === "pagamentos") return p(row, ["pagamento","Pagamento","descricao","Descri√ß√£o","concepto","Concepto"]) || ("Pagamento #" + (idx0+1));
  if (tab === "voos") return (p(row, ["numero do voo","n√∫mero do voo","N√∫mero do voo","vuelo","flight","voo"]) || "Voo") + "";
  // fallback
  return p(row, ["nome","Nome","title","titulo","T√≠tulo"]) || ("Item #" + (idx0+1));
}

function buildKvForTab(tab, row, linkMap){
  const out = [];
  const p = pickRow;

  // sempre: OBS
  const obs = p(row, ["obs","OBS","observacoes","observa√ß√µes","observaciones","observacao"]);

  // helper kvRow
  const mk = (k, v) => {
    const el = document.createElement("div");
    el.className = "kvRow";
    const kEl = document.createElement("div");
    kEl.className = "k";
    kEl.textContent = k;
    const vEl = document.createElement("div");
    vEl.className = "v";
    vEl.innerHTML = linkify(v);
    el.appendChild(kEl);
    el.appendChild(vEl);
    return el;
  };

  if (tab === "passeios") {
    out.push(mk("Data", p(row, ["Data","data","Fecha","fecha"])));
    out.push(mk("Atividade", p(row, ["passeio","Passeio","actividad","Atividad","atividade","Atividade"])));
    out.push(mk("Pick up", p(row, ["pick up","Pick up","Pickup","pickup","Pick-up","pick-up"])));
    out.push(mk("Turno", p(row, ["turno","Turno"])));
    out.push(mk("Inclui", p(row, ["inclui","Inclui","incluye","Incluye"])));
    if (obs) out.push(mk("OBS", obs));

    const best = findBestLink(row, linkMap);
    if (best) out.push(mk("Link / Anexo", best));
    return out.filter(x => !isEmptyKv(x));
  }

  if (tab === "pagamentos") {
    out.push(mk("Total do pacote", p(row, ["total do pacote","Total do pacote","total pacote","Total pacote","total","Total"])));
    out.push(mk("Data", p(row, ["data do pagamento","Data do pagamento","Data","data","Fecha","fecha"])));
    out.push(mk("Valor", p(row, ["valor","Valor","monto","Monto","importe","Importe","amount","Amount"])));
    out.push(mk("Saldo atual", p(row, ["saldo atual","Saldo atual","saldo","Saldo","balance","Balance"])));
    if (obs) out.push(mk("OBS", obs));

    const best = findBestLink(row, linkMap);
    if (best) out.push(mk("Link / Comprovante", best));
    return out.filter(x => !isEmptyKv(x));
  }

  if (tab === "voos") {
    out.push(mk("Data", p(row, ["Data","data","Fecha","fecha","date","Date"])));
    out.push(mk("N√∫mero do voo", p(row, ["numero do voo","n√∫mero do voo","N√∫mero do voo","vuelo","flight","voo","Voo"])));
    out.push(mk("Origem", p(row, ["origem","Origem","origen","from"])));
    out.push(mk("Sa√≠da", p(row, ["hora de saida","hora de sa√≠da","Hora de saida","Hora de sa√≠da","salida","departure"])));
    out.push(mk("Destino", p(row, ["destino","Destino","to"])));
    out.push(mk("Chegada", p(row, ["hora de chegada","Hora de chegada","llegada","arrival"])));
    if (obs) out.push(mk("OBS", obs));

    const best = findBestLink(row, linkMap);
    if (best) out.push(mk("Boleto / Anexo", best));
    return out.filter(x => !isEmptyKv(x));
  }

  // fallback: mostra principais chaves n√£o vazias
  Object.keys(row || {}).forEach(k=>{
    const v = (row[k] ?? "").toString().trim();
    if (!v) return;
    out.push(mk(k, v));
  });
  const best = findBestLink(row, linkMap);
  if (best) out.push(mk("Link", best));
  return out.slice(0, 18);
}

function isEmptyKv(el){
  // el .v pode estar vazio
  try{
    const v = el.querySelector(".v");
    return !v || !v.textContent.trim();
  }catch(_){ return false; }
}

function linkify(s){
  const txt = (s ?? "").toString();
  if (!txt.trim()) return "";
  // se for url, vira link clic√°vel
  if (/^https?:\/\/\S+/i.test(txt.trim())){
    const u = txt.trim();
    return `<a href="${escapeHtml(u)}" target="_blank" rel="noopener">${escapeHtml(u)}</a>`;
  }
  return escapeHtml(txt);
}

function escapeHtml(s){
  return (s ?? "").toString().replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  })[m]);
}

function pickRow(row, keys){
  const obj = row || {};
  const kk = Object.keys(obj);
  for (const want of keys){
    const k = kk.find(x => x.trim().toLowerCase() === String(want).trim().toLowerCase());
    if (k && String(obj[k] ?? "").trim() !== "") return String(obj[k]).trim();
  }
  return "";
}

function findBestLink(row, linkMap){
  // 1) link rico
  const lk = linkMap || {};
  const keys = Object.keys(lk);
  for (const k of keys){
    const u = (lk[k] || "").toString().trim();
    if (u.startsWith("http")) return u;
  }

  // 2) campos comuns no texto
  const p = pickRow;
  const candidates = [
    p(row, ["link","Link","enlace","Enlace","url","URL"]),
    p(row, ["comprovante","Comprovante","voucher","Voucher","boleto","Boleto","foto do boleto","Foto do boleto"])
  ].filter(Boolean);

  for (const c of candidates){
    const u = c.toString().trim();
    if (u.startsWith("http")) return u;
  }

  // 3) varre qualquer campo que pare√ßa url
  const obj = row || {};
  for (const k of Object.keys(obj)){
    const v = (obj[k] ?? "").toString().trim();
    if (v.startsWith("http")) return v;
  }

  return "";
}

/** =================== PDF Buttons =================== **/
function initPdfButtons(){
  document.getElementById("btnPdfSel").addEventListener("click", ()=>pdfSelected());
  document.getElementById("btnPdfTab").addEventListener("click", ()=>pdfTab());
  document.getElementById("btnPdfFull").addEventListener("click", ()=>pdfFull());
}

function getSelectedIdxForCurrentTab(){
  const out = [];
  selected.forEach((v, key)=>{
    if (!v) return;
    const [tab, idx] = key.split("|");
    if (tab === currentTab) out.push(Number(idx));
  });
  out.sort((a,b)=>a-b);
  return out;
}

async function pdfSelected(){
  try{
    const idxs = getSelectedIdxForCurrentTab();
    if (!idxs.length){
      showError("Selecione pelo menos 1 item.");
      return;
    }
    const sheetName = getSheetNameForTab(currentTab);
    setOverlay(true, "Gerando PDF‚Ä¶", "Itens selecionados.");
    const res = await api("exportPasseiosPdf", { sid: SID, token: TOKEN, sheetName, rowIdx0: idxs });
    setOverlay(false);
    if (!res.ok) throw new Error(res.error || "Erro ao gerar PDF.");
    window.open(res.downloadUrl, "_blank", "noopener");
  }catch(err){
    setOverlay(false);
    showError(String(err?.message || err));
  }
}

async function pdfTab(){
  try{
    const sheetName = getSheetNameForTab(currentTab);
    const sh = DATA?.sheets?.[sheetName];
    const n = (sh?.rows || []).length;
    if (!n){
      showError("Sem registros nesta aba.");
      return;
    }
    const idxs = Array.from({length:n}, (_,i)=>i);

    setOverlay(true, "Gerando PDF‚Ä¶", "Aba completa.");
    const res = await api("exportPasseiosPdf", { sid: SID, token: TOKEN, sheetName, rowIdx0: idxs });
    setOverlay(false);
    if (!res.ok) throw new Error(res.error || "Erro ao gerar PDF.");
    window.open(res.downloadUrl, "_blank", "noopener");
  }catch(err){
    setOverlay(false);
    showError(String(err?.message || err));
  }
}

async function pdfFull(){
  try{
    setOverlay(true, "Gerando PDF completo‚Ä¶", "Voucher + Recibo.");
    const res = await api("exportFullVoucherPdf", { sid: SID, token: TOKEN });
    setOverlay(false);
    if (!res.ok) throw new Error(res.error || "Erro ao gerar PDF completo.");
    window.open(res.downloadUrl, "_blank", "noopener");
  }catch(err){
    setOverlay(false);
    showError(String(err?.message || err));
  }
}

/** =================== Conta / Login =================== **/
function initAccount(){
  document.getElementById("btnAccount").addEventListener("click", ()=>{
    openModal("Conta", "Login e configura√ß√µes");
  });

  document.getElementById("btnCancel").addEventListener("click", ()=>closeModal());
  document.getElementById("modalMask").addEventListener("click", (ev)=>{
    if (ev.target.id === "modalMask") closeModal();
  });

  document.getElementById("btnDoLogin").addEventListener("click", ()=>doLogin());
  document.getElementById("btnSaveCreds").addEventListener("click", ()=>saveCreds());
  document.getElementById("btnLogout").addEventListener("click", ()=>logout());

  document.getElementById("btnClearSid").addEventListener("click", ()=>{
    localStorage.removeItem(LS_SID);
    localStorage.removeItem(LS_TOKEN);
    selected.clear();
    TOKEN = "";
    SID = "";
    DATA = null;
    closeModal();
    showError('Planilha removida do cache. Abra novamente com "?sid=ID_DA_PLANILHA".');
    setTitle("CRM Cliente", "Sem planilha");
    document.getElementById("list").innerHTML = "";
  });

  document.getElementById("btnReload").addEventListener("click", async ()=>{
    try{
      closeModal();
      await boot();
    }catch(_){}
  });
}

async function doLogin(){
  try{
    const user = (document.getElementById("inpUser").value || "").trim();
    const pass = (document.getElementById("inpPass").value || "").trim();
    if (!user || !pass){
      modalError("Informe usu√°rio e senha.");
      return;
    }

    setOverlay(true, "Entrando‚Ä¶", "Validando login.");
    const res = await api("validateLogin", { sid: SID, user, pass });
    setOverlay(false);

    if (!res.ok){
      modalError(res.error || "Falha no login.");
      return;
    }

    localStorage.setItem(LS_USER, user);

    if (res.token){
      TOKEN = res.token;
      localStorage.setItem(LS_TOKEN, TOKEN);
    } else {
      TOKEN = "";
      localStorage.removeItem(LS_TOKEN);
    }

    closeModal();

    await loadData();
    render();
  }catch(err){
    setOverlay(false);
    modalError(String(err?.message || err));
  }
}

async function saveCreds(){
  try{
    const user = (document.getElementById("inpNewUser").value || "").trim();
    const pass = (document.getElementById("inpNewPass").value || "").trim();
    if (!user || !pass){
      modalError("Preencha novo usu√°rio e nova senha.");
      return;
    }

    setOverlay(true, "Salvando‚Ä¶", "Atualizando login.");
    const res = await api("updateLogin", { sid: SID, token: TOKEN, user, pass });
    setOverlay(false);

    if (!res.ok){
      modalError(res.error || "Erro ao salvar login.");
      return;
    }

    // salva para facilitar o pr√≥ximo login
    localStorage.setItem(LS_USER, user);
    document.getElementById("inpUser").value = user;
    document.getElementById("inpPass").value = "";
    document.getElementById("inpNewUser").value = "";
    document.getElementById("inpNewPass").value = "";

    // mensagem simples
    modalError("Login atualizado com sucesso.");
    // muda estilo da msg para "ok" (sem criar novo css)
    const m = document.getElementById("modalMsg");
    m.style.borderColor = "rgba(22,163,74,.18)";
    m.style.background = "rgba(22,163,74,.08)";
    m.style.color = "#15803d";
  }catch(err){
    setOverlay(false);
    modalError(String(err?.message || err));
  }
}

function logout(){
  localStorage.removeItem(LS_TOKEN);
  TOKEN = "";
  selected.clear();
  closeModal();
  boot();
}
</script>
</body>
</html>
